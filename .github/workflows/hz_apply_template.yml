name: 'Apply'

on:
  workflow_call:
    inputs:
      aws-region:
        required: false
        type: string
        default: 'eu-central-1'
      aws-role:
        required: true
        type: string
      runner_label:
        required: false
        type: string
        default: 'small'
      terraform-version:
        required: false
        type: string
        default: '1.5.7'

jobs:
  deploy:
    name: 'Deploying'
    runs-on: ${{inputs.runner_label}}
    timeout-minutes: 60
    container:
      image: microwave88/custom-tf-cdktf-runner:${{ inputs.terraform-version }}

    steps:
    - name: Checkout
      uses: actions/checkout@v5

    - name: Checkout route53 records package
      uses: actions/checkout@v5
      with:
        repository: BNGUYENLAB/rdm-route53-records-package
        ref: main
        path: route53-records-package
    
    # - name: Install terraform
    #   uses: hashicorp/setup-terraform@v3
    #   with:
    #     terraform_version: ${{ inputs.terraform-version }}

    # - name: Set up Python
    #   uses: actions/setup-python@v5
    #   with:
    #     python-version: '3.11'

    # - name: Install pipenv
    #   run: |
    #     python -m pip install --upgrade pip
    #     pip install pipenv

    # - name: Install Node.js
    #   uses: actions/setup-node@v4
    #   with:
    #     node-version: '20'

    # - name: Install CDKTF CLI
    #   run: npm install --global cdktf-cli@latest

    # - name: Install Python packages
    #   run: |
    #     pipenv run pip install -e route53-records-package/

    - name: Configure AWS credentials (Admin) via OIDC
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ inputs.aws-role }}
        role-session-name: GitHubActions-Apply-${{ github.run_id }}
        aws-region: ${{ inputs.aws-region }}

    - name: CDKTF Deploy
      run: |
        pipenv run cdktf deploy --auto-approve

    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "✅ CDKTF deployment completed successfully"
        else
          echo "❌ CDKTF deployment failed"
          exit 1
        fi